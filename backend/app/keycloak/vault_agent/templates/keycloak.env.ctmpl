{{- /*
keycloak.env.ctmpl (v4)
Renders a shell-compatible env file for Keycloak from Vault KV v2.

Vault paths used (KV v2):
  - app_postgres_secrets/data/keycloak_postgres   (DB settings)
  - app_postgres_secrets/data/keycloak_bootstrap (bootstrap admin creds)
  - app_postgres_secrets/data/keycloak_runtime   (runtime hostname/proxy/listeners/observability)

This template:
  - Never emits %!q(<nil>) (guards missing keys)
  - Ensures each env var is on its own line
  - Uses printf "%q" for safe shell quoting
*/ -}}

{{- with secret "app_postgres_secrets/data/keycloak_postgres" -}}
KC_DB={{ printf "%q" (or .Data.data.KC_DB "postgres") }}
KC_DB_URL_HOST={{ printf "%q" .Data.data.KC_DB_URL_HOST }}
KC_DB_URL_PORT={{ printf "%q" .Data.data.KC_DB_URL_PORT }}
KC_DB_URL_DATABASE={{ printf "%q" .Data.data.KC_DB_URL_DATABASE }}
KC_DB_USERNAME={{ printf "%q" .Data.data.KC_DB_USERNAME }}
KC_DB_PASSWORD={{ printf "%q" .Data.data.KC_DB_PASSWORD }}
KC_DB_SCHEMA={{ printf "%q" (or .Data.data.KC_DB_SCHEMA "public") }}
{{- end }}
{{ "\n" }}

{{- with secret "app_postgres_secrets/data/keycloak_bootstrap" -}}
KC_BOOTSTRAP_ADMIN_USERNAME={{ printf "%q" .Data.data.KC_BOOTSTRAP_ADMIN_USERNAME }}
KC_BOOTSTRAP_ADMIN_PASSWORD={{ printf "%q" .Data.data.KC_BOOTSTRAP_ADMIN_PASSWORD }}
{{- end }}
{{ "\n" }}

{{- with secret "app_postgres_secrets/data/keycloak_runtime" -}}
{{- /* Only emit runtime keys if present; otherwise omit them cleanly. */ -}}
{{- if .Data.data.KC_HOSTNAME }}KC_HOSTNAME={{ printf "%q" .Data.data.KC_HOSTNAME }}{{ "\n" }}{{- end }}
{{- if .Data.data.KC_HOSTNAME_STRICT }}KC_HOSTNAME_STRICT={{ printf "%q" .Data.data.KC_HOSTNAME_STRICT }}{{ "\n" }}{{- end }}
{{- if .Data.data.KC_PROXY_HEADERS }}KC_PROXY_HEADERS={{ printf "%q" .Data.data.KC_PROXY_HEADERS }}{{ "\n" }}{{- end }}
{{- if .Data.data.KC_PROXY_TRUSTED_ADDRESSES }}KC_PROXY_TRUSTED_ADDRESSES={{ printf "%q" .Data.data.KC_PROXY_TRUSTED_ADDRESSES }}{{ "\n" }}{{- end }}

{{- if .Data.data.KC_HTTP_ENABLED }}KC_HTTP_ENABLED={{ printf "%q" .Data.data.KC_HTTP_ENABLED }}{{ "\n" }}{{- end }}
{{- if .Data.data.KC_HTTPS_PORT }}KC_HTTPS_PORT={{ printf "%q" .Data.data.KC_HTTPS_PORT }}{{ "\n" }}{{- end }}

{{- if .Data.data.KC_HEALTH_ENABLED }}KC_HEALTH_ENABLED={{ printf "%q" .Data.data.KC_HEALTH_ENABLED }}{{ "\n" }}{{- end }}
{{- if .Data.data.KC_METRICS_ENABLED }}KC_METRICS_ENABLED={{ printf "%q" .Data.data.KC_METRICS_ENABLED }}{{ "\n" }}{{- end }}
{{- if .Data.data.KC_HTTP_MANAGEMENT_PORT }}KC_HTTP_MANAGEMENT_PORT={{ printf "%q" .Data.data.KC_HTTP_MANAGEMENT_PORT }}{{ "\n" }}{{- end }}
{{- if .Data.data.KC_HTTP_MANAGEMENT_SCHEME }}KC_HTTP_MANAGEMENT_SCHEME={{ printf "%q" .Data.data.KC_HTTP_MANAGEMENT_SCHEME }}{{ "\n" }}{{- end }}
{{- if .Data.data.KC_LOG_LEVEL }}KC_LOG_LEVEL={{ printf "%q" .Data.data.KC_LOG_LEVEL }}{{ "\n" }}{{- end }}
{{- end }}
