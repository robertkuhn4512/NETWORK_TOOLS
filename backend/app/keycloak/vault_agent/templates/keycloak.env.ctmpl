{{- /*
keycloak.env.ctmpl
Renders a shell-compatible env file for Keycloak from Vault KV v2.

Vault paths used (KV v2):
  - app_postgres_secrets/data/keycloak_postgres   (DB settings)
  - app_postgres_secrets/data/keycloak_bootstrap (bootstrap admin creds)
  - app_postgres_secrets/data/keycloak_runtime   (runtime hostname/proxy/listeners/observability)

Notes:
  - Keycloak reads TLS from FILES (KC_HTTPS_CERTIFICATE_FILE / KC_HTTPS_CERTIFICATE_KEY_FILE).
    Those files should be rendered by separate templates (e.g., keycloak_tls.crt.ctmpl / keycloak_tls.key.ctmpl).
  - This template:
      * Emits one KEY=VALUE per line
      * Uses printf "%q" for safe shell quoting
      * Guards missing keys (won’t emit nil markers)
      * Avoids whitespace trimming that would comment-out the first env var
*/ -}}

{{- $nl := "\n" -}}

#------------------------------------------------------------------------------
# Generated by Vault Agent – DO NOT EDIT
#------------------------------------------------------------------------------
{{ $nl }}

{{- /* -----------------------------------------------------------------------
      DB settings
    ----------------------------------------------------------------------- */ -}}
{{- with secret "app_postgres_secrets/data/keycloak_postgres" -}}
{{- $d := .Data.data -}}
{{- if $d.KC_DB }}KC_DB={{ printf "%q" $d.KC_DB }}{{ $nl }}{{- end }}
{{- if $d.KC_DB_URL_HOST }}KC_DB_URL_HOST={{ printf "%q" $d.KC_DB_URL_HOST }}{{ $nl }}{{- end }}
{{- if $d.KC_DB_URL_PORT }}KC_DB_URL_PORT={{ printf "%q" $d.KC_DB_URL_PORT }}{{ $nl }}{{- end }}
{{- if $d.KC_DB_URL_DATABASE }}KC_DB_URL_DATABASE={{ printf "%q" $d.KC_DB_URL_DATABASE }}{{ $nl }}{{- end }}
{{- if $d.KC_DB_USERNAME }}KC_DB_USERNAME={{ printf "%q" $d.KC_DB_USERNAME }}{{ $nl }}{{- end }}
{{- if $d.KC_DB_PASSWORD }}KC_DB_PASSWORD={{ printf "%q" $d.KC_DB_PASSWORD }}{{ $nl }}{{- end }}
{{- if $d.KC_DB_URL_PROPERTIES }}KC_DB_URL_PROPERTIES={{ printf "%q" $d.KC_DB_URL_PROPERTIES }}{{ $nl }}{{- end }}
{{- end }}
{{ $nl }}

{{- /* -----------------------------------------------------------------------
      Bootstrap admin credentials
    ----------------------------------------------------------------------- */ -}}
{{- with secret "app_postgres_secrets/data/keycloak_bootstrap" -}}
{{- $b := .Data.data -}}
{{- if $b.KEYCLOAK_ADMIN }}KEYCLOAK_ADMIN={{ printf "%q" $b.KEYCLOAK_ADMIN }}{{ $nl }}{{- end }}
{{- if $b.KEYCLOAK_ADMIN_PASSWORD }}KEYCLOAK_ADMIN_PASSWORD={{ printf "%q" $b.KEYCLOAK_ADMIN_PASSWORD }}{{ $nl }}{{- end }}
{{- if $b.KC_BOOTSTRAP_ADMIN_USERNAME }}KC_BOOTSTRAP_ADMIN_USERNAME={{ printf "%q" $b.KC_BOOTSTRAP_ADMIN_USERNAME }}{{ $nl }}{{- end }}
{{- if $b.KC_BOOTSTRAP_ADMIN_PASSWORD }}KC_BOOTSTRAP_ADMIN_PASSWORD={{ printf "%q" $b.KC_BOOTSTRAP_ADMIN_PASSWORD }}{{ $nl }}{{- end }}
{{- end }}
{{ $nl }}

{{- /* -----------------------------------------------------------------------
      Runtime settings
    ----------------------------------------------------------------------- */ -}}
{{- with secret "app_postgres_secrets/data/keycloak_runtime" -}}
{{- $r := .Data.data -}}
{{- if $r.KC_HOSTNAME }}KC_HOSTNAME={{ printf "%q" $r.KC_HOSTNAME }}{{ $nl }}{{- end }}
{{- if $r.KC_HOSTNAME_STRICT }}KC_HOSTNAME_STRICT={{ printf "%q" $r.KC_HOSTNAME_STRICT }}{{ $nl }}{{- end }}
{{- if $r.KC_HOSTNAME_STRICT_HTTPS }}KC_HOSTNAME_STRICT_HTTPS={{ printf "%q" $r.KC_HOSTNAME_STRICT_HTTPS }}{{ $nl }}{{- end }}

{{- if $r.KC_PROXY_HEADERS }}KC_PROXY_HEADERS={{ printf "%q" $r.KC_PROXY_HEADERS }}{{ $nl }}{{- end }}
{{- if $r.KC_PROXY_TRUSTED_ADDRESSES }}KC_PROXY_TRUSTED_ADDRESSES={{ printf "%q" $r.KC_PROXY_TRUSTED_ADDRESSES }}{{ $nl }}{{- end }}

{{- if $r.KC_HTTP_ENABLED }}KC_HTTP_ENABLED={{ printf "%q" $r.KC_HTTP_ENABLED }}{{ $nl }}{{- end }}
{{- if $r.KC_HTTP_PORT }}KC_HTTP_PORT={{ printf "%q" $r.KC_HTTP_PORT }}{{ $nl }}{{- end }}
{{- if $r.KC_HTTPS_PORT }}KC_HTTPS_PORT={{ printf "%q" $r.KC_HTTPS_PORT }}{{ $nl }}{{- end }}

{{- if $r.KC_HEALTH_ENABLED }}KC_HEALTH_ENABLED={{ printf "%q" $r.KC_HEALTH_ENABLED }}{{ $nl }}{{- end }}
{{- if $r.KC_METRICS_ENABLED }}KC_METRICS_ENABLED={{ printf "%q" $r.KC_METRICS_ENABLED }}{{ $nl }}{{- end }}
{{- if $r.KC_HTTP_MANAGEMENT_PORT }}KC_HTTP_MANAGEMENT_PORT={{ printf "%q" $r.KC_HTTP_MANAGEMENT_PORT }}{{ $nl }}{{- end }}
{{- if $r.KC_HTTP_MANAGEMENT_SCHEME }}KC_HTTP_MANAGEMENT_SCHEME={{ printf "%q" $r.KC_HTTP_MANAGEMENT_SCHEME }}{{ $nl }}{{- end }}

{{- if $r.KC_LOG_LEVEL }}KC_LOG_LEVEL={{ printf "%q" $r.KC_LOG_LEVEL }}{{ $nl }}{{- end }}
{{- end }}
{{ $nl }}

{{- /* -----------------------------------------------------------------------
      TLS file locations (Keycloak reads PEM from files; Agent renders those separately)
    ----------------------------------------------------------------------- */ -}}
{{- with secret "app_postgres_secrets/data/keycloak_runtime" -}}
{{- $r := .Data.data -}}
{{- if not $r.KC_HTTPS_CERTIFICATE_FILE }}KC_HTTPS_CERTIFICATE_FILE={{ printf "%q" "/run/vault/tls/server.crt" }}{{ $nl }}{{- end }}
{{- if not $r.KC_HTTPS_CERTIFICATE_KEY_FILE }}KC_HTTPS_CERTIFICATE_KEY_FILE={{ printf "%q" "/run/vault/tls/server.key" }}{{ $nl }}{{- end }}
{{- end }}
