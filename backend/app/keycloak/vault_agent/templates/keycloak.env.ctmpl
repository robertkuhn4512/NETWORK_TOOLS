{{- /*
keycloak.env.ctmpl

Renders a shell-compatible env file for Keycloak from Vault KV v2.

Vault paths used (KV v2):
  - app_network_tools_secrets/data/keycloak_postgres   (DB settings)
  - app_network_tools_secrets/data/keycloak_bootstrap (bootstrap admin creds)
  - app_network_tools_secrets/data/keycloak_runtime   (runtime hostname/proxy/listeners/observability)

Design goals (Network Tools):
  - Keycloak runs HTTP inside the Docker network.
  - Nginx terminates TLS and reverse-proxies to Keycloak over HTTP.
  - PRIMARY_SERVER_FQDN (from .env) is the canonical external hostname.
  - Vault remains the source of truth: defaults are emitted, then Vault keys override.

Hardening goals (avoid template/config footguns):
  - Always emit BOTH:
      * KC_DB_URL (full JDBC URL)
      * KC_DB_URL_HOST / KC_DB_URL_PORT / KC_DB_URL_DATABASE / KC_DB_URL_PROPERTIES
    This ensures compatibility with any wrapper scripts that insist on split variables,
    while also giving Keycloak a correct full URL.

  - Normalize KC_DB_URL_PROPERTIES so it ALWAYS starts with '?', or is empty.
    (Prevents the classic "keycloaksslmode=disable" concatenation error.)

Notes:
  - Do NOT emit KC_HTTPS_* file settings here.
  - Emits one KEY=VALUE per line.
  - Uses printf "%q" for safe shell quoting.
*/ -}}

{{- $nl := "\n" -}}

{{- /* -----------------------------------------------------------------------
      Runtime defaults (may be overridden by Vault)
    ----------------------------------------------------------------------- */ -}}
{{- $fqdn := or (env "PRIMARY_SERVER_FQDN") "keycloak" -}}
{{- $trusted := or (env "KEYCLOAK_PROXY_TRUSTED_ADDRESSES") "172.30.20.0/24,172.30.0.0/16" -}}


{{- $kc_http_port := "8080" -}}
{{- $kc_proxy_trusted := $trusted -}}
{{- $kc_http_mgmt_port := "9000" -}}
{{- $kc_http_mgmt_scheme := "http" -}}
{{- $kc_log_level := "" -}}

{{- with secret "app_network_tools_secrets/data/keycloak_runtime" -}}
{{- $r := .Data.data -}}
{{- if $r.KC_PROXY_TRUSTED_ADDRESSES }}{{- $kc_proxy_trusted = $r.KC_PROXY_TRUSTED_ADDRESSES -}}{{- end -}}
{{- if $r.KC_HTTP_PORT }}{{- $kc_http_port = $r.KC_HTTP_PORT -}}{{- end -}}
{{- if $r.KC_HTTP_MANAGEMENT_PORT }}{{- $kc_http_mgmt_port = $r.KC_HTTP_MANAGEMENT_PORT -}}{{- end -}}
{{- if $r.KC_LOG_LEVEL }}{{- $kc_log_level = $r.KC_LOG_LEVEL -}}{{- end -}}
{{- end -}}

{{- /* -----------------------------------------------------------------------
      DB defaults (may be overridden by Vault)
    ----------------------------------------------------------------------- */ -}}
{{- $kc_db := "postgres" -}}
{{- $kc_db_host := "postgres_primary" -}}
{{- $kc_db_port := "5432" -}}
{{- $kc_db_database := "keycloak" -}}
{{- $kc_db_user := "keycloak" -}}
{{- $kc_db_password := "" -}}
{{- $kc_db_props := "?sslmode=disable" -}}

{{- with secret "app_network_tools_secrets/data/keycloak_postgres" -}}
{{- $d := .Data.data -}}
{{- if $d.KC_DB }}{{- $kc_db = $d.KC_DB -}}{{- end -}}
{{- if $d.KC_DB_URL_HOST }}{{- $kc_db_host = $d.KC_DB_URL_HOST -}}{{- end -}}
{{- if $d.KC_DB_URL_PORT }}{{- $kc_db_port = $d.KC_DB_URL_PORT -}}{{- end -}}
{{- if $d.KC_DB_URL_DATABASE }}{{- $kc_db_database = $d.KC_DB_URL_DATABASE -}}{{- end -}}
{{- if $d.KC_DB_USERNAME }}{{- $kc_db_user = $d.KC_DB_USERNAME -}}{{- end -}}
{{- if $d.KC_DB_PASSWORD }}{{- $kc_db_password = $d.KC_DB_PASSWORD -}}{{- end -}}
{{- if $d.KC_DB_URL_PROPERTIES }}{{- $kc_db_props = $d.KC_DB_URL_PROPERTIES -}}{{- end -}}
{{- end -}}

{{- /* Normalize DB name: strip any accidental query string fragments */ -}}
{{- $kc_db_database = regexReplaceAll "[?].*$" $kc_db_database "" -}}
{{- $kc_db_database = regexReplaceAll "^[[:space:]]+|[[:space:]]+$" $kc_db_database "" -}}
{{- if eq $kc_db_database "" -}}{{- $kc_db_database = "keycloak" -}}{{- end -}}

{{- /* Normalize DB props:
      - empty => ""
      - otherwise => ensure it starts with '?'
      - '&...' becomes '?...'

   Implementation avoids relying on hasPrefix/regexMatch.
*/ -}}
{{- $kc_db_props = regexReplaceAll "^[[:space:]]+|[[:space:]]+$" $kc_db_props "" -}}
{{- if eq $kc_db_props "" -}}
  {{- /* empty/blank in Vault => apply safe default */ -}}
  {{- $kc_db_props = "sslmode=disable" -}}
{{- end -}}
{{- /* Ensure the first delimiter is '?' */ -}}
{{- $kc_db_props = printf "?%s" $kc_db_props -}}
{{- $kc_db_props = regexReplaceAll "^[?]&" $kc_db_props "?" -}}
{{- $kc_db_props = regexReplaceAll "^[?]{2}" $kc_db_props "?" -}}

{{- /* Build full JDBC URL (Postgres) */ -}}
{{- $kc_db_url := "" -}}
{{- if eq $kc_db "postgres" -}}
  {{- $kc_db_url = printf "jdbc:postgresql://%s:%s/%s%s" $kc_db_host $kc_db_port $kc_db_database $kc_db_props -}}
{{- end -}}

#------------------------------------------------------------------------------
# Generated by Vault Agent â€“ DO NOT EDIT
#------------------------------------------------------------------------------
{{ $nl }}

# --- Runtime ---
KC_HTTP_PORT={{ printf "%q" $kc_http_port }}{{ $nl }}
KC_PROXY_TRUSTED_ADDRESSES={{ printf "%q" $kc_proxy_trusted }}{{ $nl }}
KC_HTTP_MANAGEMENT_PORT={{ printf "%q" $kc_http_mgmt_port }}{{ $nl }}
{{- if ne $kc_log_level "" }}KC_LOG_LEVEL={{ printf "%q" $kc_log_level }}{{ $nl }}{{- end }}
{{ $nl }}

# --- Database ---
KC_DB={{ printf "%q" $kc_db }}{{ $nl }}
KC_DB_URL_HOST={{ printf "%q" $kc_db_host }}{{ $nl }}
KC_DB_URL_PORT={{ printf "%q" $kc_db_port }}{{ $nl }}
KC_DB_URL_DATABASE={{ printf "%q" $kc_db_database }}{{ $nl }}
KC_DB_URL_PROPERTIES={{ printf "%q" $kc_db_props }}{{ $nl }}
KC_DB_URL={{ printf "%q" $kc_db_url }}{{ $nl }}
KC_DB_USERNAME={{ printf "%q" $kc_db_user }}{{ $nl }}
{{- if ne $kc_db_password "" }}KC_DB_PASSWORD={{ printf "%q" $kc_db_password }}{{ $nl }}{{- end }}
{{ $nl }}

# --- Bootstrap admin (Vault overrides) ---
{{ $nl }}{{- with secret "app_network_tools_secrets/data/keycloak_bootstrap" -}}
{{- $b := .Data.data -}}
{{- if $b.KEYCLOAK_ADMIN }}KEYCLOAK_ADMIN={{ printf "%q" $b.KEYCLOAK_ADMIN }}{{ $nl }}{{- end }}
{{- if $b.KEYCLOAK_ADMIN_PASSWORD }}KEYCLOAK_ADMIN_PASSWORD={{ printf "%q" $b.KEYCLOAK_ADMIN_PASSWORD }}{{ $nl }}{{- end }}
{{- if $b.KC_BOOTSTRAP_ADMIN_USERNAME }}KC_BOOTSTRAP_ADMIN_USERNAME={{ printf "%q" $b.KC_BOOTSTRAP_ADMIN_USERNAME }}{{ $nl }}{{- end }}
{{- if $b.KC_BOOTSTRAP_ADMIN_PASSWORD }}KC_BOOTSTRAP_ADMIN_PASSWORD={{ printf "%q" $b.KC_BOOTSTRAP_ADMIN_PASSWORD }}{{ $nl }}{{- end }}
{{- end }}
