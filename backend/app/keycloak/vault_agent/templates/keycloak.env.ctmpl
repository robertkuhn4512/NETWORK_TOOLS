# keycloak.env.ctmpl
#
# Rendered by Vault Agent. This file is sourced by the Keycloak container entrypoint.
# It pulls from KV v2:
#   - app_postgres_secrets/data/keycloak_postgres   (DB settings)
#   - app_postgres_secrets/data/keycloak_bootstrap (admin creds)
#   - app_postgres_secrets/data/keycloak_runtime   (runtime settings)
#
# IMPORTANT:
# - Values MUST be single-line.
# - Use explicit conditionals / `or` (Go template builtin) â€” do not rely on Sprig `default`.

{{- with secret "app_postgres_secrets/data/keycloak_postgres" -}}
KC_DB={{ or .Data.data.KC_DB "postgres" }}
KC_DB_URL_HOST={{ or .Data.data.KC_DB_URL_HOST "postgres_primary" }}
KC_DB_URL_PORT={{ or .Data.data.KC_DB_URL_PORT "5432" }}
KC_DB_URL_DATABASE={{ or .Data.data.KC_DB_URL_DATABASE "keycloak" }}
KC_DB_USERNAME={{ or .Data.data.KC_DB_USERNAME "keycloak" }}
KC_DB_PASSWORD={{ .Data.data.KC_DB_PASSWORD }}
KC_DB_SCHEMA={{ or .Data.data.KC_DB_SCHEMA "public" }}
{{- if .Data.data.KC_DB_URL_PROPERTIES }}
KC_DB_URL_PROPERTIES={{ .Data.data.KC_DB_URL_PROPERTIES }}
{{- end }}
{{- end }}

{{- with secret "app_postgres_secrets/data/keycloak_bootstrap" -}}
KC_BOOTSTRAP_ADMIN_USERNAME={{ or .Data.data.KC_BOOTSTRAP_ADMIN_USERNAME "temp-admin" }}
KC_BOOTSTRAP_ADMIN_PASSWORD={{ .Data.data.KC_BOOTSTRAP_ADMIN_PASSWORD }}
{{- end }}

{{- with secret "app_postgres_secrets/data/keycloak_runtime" -}}
KC_HOSTNAME={{ .Data.data.KC_HOSTNAME }}
KC_HOSTNAME_STRICT={{ or .Data.data.KC_HOSTNAME_STRICT "true" }}
KC_HTTP_RELATIVE_PATH={{ or .Data.data.KC_HTTP_RELATIVE_PATH "/" }}

# Prefer HTTPS when not behind a reverse proxy
KC_HTTP_ENABLED={{ or .Data.data.KC_HTTP_ENABLED "false" }}
KC_HTTPS_PORT={{ or .Data.data.KC_HTTPS_PORT "8443" }}
KC_HTTPS_CERTIFICATE_FILE={{ or .Data.data.KC_HTTPS_CERTIFICATE_FILE "/run/vault/keycloak_tls.crt" }}
KC_HTTPS_CERTIFICATE_KEY_FILE={{ or .Data.data.KC_HTTPS_CERTIFICATE_KEY_FILE "/run/vault/keycloak_tls.key" }}

# Observability (management interface)
KC_HEALTH_ENABLED={{ or .Data.data.KC_HEALTH_ENABLED "true" }}
KC_METRICS_ENABLED={{ or .Data.data.KC_METRICS_ENABLED "true" }}
KC_HTTP_MANAGEMENT_PORT={{ or .Data.data.KC_HTTP_MANAGEMENT_PORT "9000" }}
KC_HTTP_MANAGEMENT_RELATIVE_PATH={{ or .Data.data.KC_HTTP_MANAGEMENT_RELATIVE_PATH "/" }}
KC_HTTP_MANAGEMENT_SCHEME={{ or .Data.data.KC_HTTP_MANAGEMENT_SCHEME "http" }}

# Reverse proxy settings (only if you set them in Vault)
{{- if .Data.data.KC_PROXY_HEADERS }}
KC_PROXY_HEADERS={{ .Data.data.KC_PROXY_HEADERS }}
{{- end }}
{{- if .Data.data.KC_PROXY_TRUSTED_ADDRESSES }}
KC_PROXY_TRUSTED_ADDRESSES={{ .Data.data.KC_PROXY_TRUSTED_ADDRESSES }}
{{- end }}

{{- if .Data.data.KC_LOG_LEVEL }}
KC_LOG_LEVEL={{ .Data.data.KC_LOG_LEVEL }}
{{- end }}
{{- end }}
