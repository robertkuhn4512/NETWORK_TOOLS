# Allow only pgadmin/keycloak/fastapi (Not built yet) by container IP
# Useful resource - https://www.postgresql.org/docs/current/auth-pg-hba-conf.html
#
# local               database  user  auth-method [auth-options]
# host                database  user  address     auth-method  [auth-options]
# hostssl             database  user  address     auth-method  [auth-options]
# hostnossl           database  user  address     auth-method  [auth-options]
# hostgssenc          database  user  address     auth-method  [auth-options]
# hostnogssenc        database  user  address     auth-method  [auth-options]
# host                database  user  IP-address  IP-mask      auth-method  [auth-options]
# hostssl             database  user  IP-address  IP-mask      auth-method  [auth-options]
# hostnossl           database  user  IP-address  IP-mask      auth-method  [auth-options]
# hostgssenc          database  user  IP-address  IP-mask      auth-method  [auth-options]
# hostnogssenc        database  user  IP-address  IP-mask      auth-method  [auth-options]
# include             file
# include_if_exists   file
# include_dir         directory

# Allow ONLY specific containers by IP (no global 0.0.0.0/0 allows)
# Docs: https://www.postgresql.org/docs/current/auth-pg-hba-conf.html
#
# TYPE      DATABASE     USER               ADDRESS            METHOD

# 1) Local socket connections (inside the postgres container)
local       all          all                                   scram-sha-256

# 2) Loopback TCP (optional, but handy for some tooling/healthchecks)
host        all          all                127.0.0.1/32       scram-sha-256
host        all          all                ::1/128            scram-sha-256

# 3) Container allowlist over SSL ONLY
# NOTE: Replace these IPs with your actual container IPs.

# Postgres container talking to itself via TCP (e.g., "host=postgres_primary")
host     all          network_tools_user 172.30.20.10/32    scram-sha-256

# PGAdmin container
host     all          network_tools_user 172.30.20.20/32    scram-sha-256

# Keycloak container (FIX THIS IP â€” your file currently duplicates .20)
# Tighten to keycloak DB/user if you want:
host     keycloak     keycloak           172.30.20.30/32    scram-sha-256

# FastAPI container (set the real IP)
host     all          network_tools_user 172.30.20.40/32    scram-sha-256

# 4) Enforce SSL-only for the Docker subnet (reject any non-SSL attempts)
hostnossl   all          all                172.30.20.0/24     reject

# 5) Default deny (explicit)
host        all          all                0.0.0.0/0          reject
host        all          all                ::/0               reject

# Replication (only if you actually use it; otherwise remove)
local       replication  all                                   scram-sha-256
host        replication  all                127.0.0.1/32       scram-sha-256
host        replication  all                ::1/128            scram-sha-256